name: Score Submission

on:
  pull_request:
    paths:
      - 'submissions/*.csv'
  workflow_dispatch:

jobs:
  score:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas scikit-learn torch torch-geometric

      - name: Restore private test labels
        env:
          TEST_LABELS_CSV_B64: ${{ secrets.TEST_LABELS_CSV_B64 }}
        run: |
          if [ -z "$TEST_LABELS_CSV_B64" ]; then
            echo "Missing TEST_LABELS_CSV_B64 secret"
            exit 1
          fi
          mkdir -p data
          echo "$TEST_LABELS_CSV_B64" | base64 -d > data/test_labels.csv

      - name: Find submission file
        id: find_submission
        run: |
          SUBMISSION=$(git diff --name-only origin/main HEAD | grep "submissions/" | grep ".csv" | head -1)
          if [ -z "$SUBMISSION" ]; then
            echo "No submission file found"
            exit 1
          fi
          echo "submission=$SUBMISSION" >> $GITHUB_OUTPUT

      - name: Run scoring script
        id: score
        run: |
          python scoring_script.py "${{ steps.find_submission.outputs.submission }}"
        continue-on-error: true

      - name: Extract metrics and comment
        if: steps.score.outcome == 'success'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const submissionFile = "${{ steps.find_submission.outputs.submission }}";
            const metrics = require('child_process').execSync(
              `python scoring_script.py ${submissionFile}`,
              { encoding: 'utf-8' }
            );
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üèÜ Submission Scored\n\n\`\`\`\n${metrics}\n\`\`\`\n\nCheck the [leaderboard](https://github.com/${{ github.repository }}/blob/main/leaderboard.md) for rankings!`
            });

      - name: Update leaderboard
        if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
        run: |
          python update_leaderboard.py

      - name: Commit leaderboard update
        if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add leaderboard.md
          git commit -m "Update leaderboard with new submission" || true
          git push

      - name: Cleanup private labels
        if: always()
        run: |
          rm -f data/test_labels.csv
